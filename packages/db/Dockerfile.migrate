FROM node:20-slim
WORKDIR /repo

RUN apt-get update && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*
RUN npm install -g pnpm

COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY packages/db/package.json packages/db/package.json
COPY packages/db ./packages/db

RUN pnpm install --frozen-lockfile --prod --filter @app/db...

WORKDIR /repo/packages/db
CMD ["pnpm", "db:deploy"]
